---
- name: Master puppet
  hosts: master.puppet
  become: true

  tasks:
    - name: Add Puppet Yum Repository
      yum_repository:
        name: puppet
        description: Puppet Labs Products
        baseurl: https://yum.puppet.com/puppet7-release-el-8.noarch.rpm
        gpgcheck: no

    - name: Install Puppet Server and r10k
      package:
        name: "{{ item }}"
        state: present
      loop:
        - epel-release
        - puppetserver
        - git
      notify:
        - start puppet server

  handlers:
    - name: start puppet server
      systemd:
        name: puppetserver
        state: started
        enabled: yes

- name: Slaves
  hosts: slave1.puppet:slave2.puppet
  become: true

  tasks:
    - name: Add Puppet Yum Repository
      yum_repository:
        name: puppet
        description: Puppet Labs Products
        baseurl: https://yum.puppet.com/puppet7-release-el-8.noarch.rpm
        gpgcheck: no

    - name: Install Puppet Agent and PHP
      package:
        name: "{{ item }}"
        state: present
      loop:
        - puppet-agent
        - apache2
        - php
        - git

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
